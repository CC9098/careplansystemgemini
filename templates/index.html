<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>護理計劃AI分析系統</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-decoration">
                <div class="header-svg header-svg-left">
                    <svg width="100" height="100" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="25" cy="25" r="20" fill="#FADADD" opacity="0.6"/>
                        <circle cx="75" cy="15" r="15" fill="#F2A5A8" opacity="0.5"/>
                        <circle cx="10" cy="70" r="25" fill="#FEF2F3" opacity="0.7"/>
                    </svg>
                </div>
                <div class="header-svg header-svg-right">
                    <svg width="120" height="120" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="95" cy="95" r="20" fill="#FFC07F" opacity="0.4"/>
                        <circle cx="25" cy="105" r="15" fill="#A5CBAF" opacity="0.5"/>
                        <circle cx="110" cy="30" r="25" fill="#FADADD" opacity="0.3"/>
                    </svg>
                </div>
            </div>

            <div class="upload-icon">
                <div class="brand-container">
                    <div class="brand-circle">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="#F08080" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="brand-accent"></div>
                </div>
            </div>

            <h1>護理計劃 AI 分析系統</h1>
            <p>上傳住戶日誌和現有護理計劃，AI 將為您分析並提供優化建議</p>
        </header>

        <main>
            <form id="uploadForm" class="upload-section">
                <div class="form-group">
                    <label for="resident_name">住戶姓名：</label>
                    <input type="text" id="resident_name" name="resident_name" placeholder="請輸入住戶姓名" required>
                </div>

                <div class="upload-grid">
                    <div class="upload-area">
                        <div class="upload-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke="#F08080" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <polyline points="14,2 14,8 20,8" stroke="#F08080" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <line x1="16" y1="13" x2="8" y2="13" stroke="#F08080" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <line x1="16" y1="17" x2="8" y2="17" stroke="#F08080" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <polyline points="10,9 9,9 8,9" stroke="#F08080" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <h3>每日護理日誌</h3>
                        <p>請上傳包含住戶日常護理記錄的檔案</p>
                        <input type="file" id="daily_log" name="daily_log" accept=".csv,.txt,.pdf" required>
                        <label for="daily_log" class="file-input-label">選擇檔案</label>
                        <p class="file-info">支援格式：CSV, TXT, PDF</p>
                    </div>

                    <div class="upload-area">
                        <div class="upload-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" stroke="#A5CBAF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <polyline points="14,2 14,8 20,8" stroke="#A5CBAF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M12 18v-6l-2 2" stroke="#A5CBAF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="m10 14 2-2 2 2" stroke="#A5CBAF" stroke="#A5CBAF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <h3>現有護理計劃</h3>
                        <p>請上傳住戶目前的護理計劃檔案</p>
                        <input type="file" id="care_plan" name="care_plan" accept=".csv,.txt,.pdf" required>
                        <label for="care_plan" class="file-input-label">選擇檔案</label>
                        <p class="file-info">支援格式：CSV, TXT, PDF</p>
                    </div>
                </div>

                <button type="submit" class="analyze-btn">
                    <span class="btn-text">開始 AI 分析</span>
                    <div class="btn-spinner" style="display: none;"></div>
                </button>
            </form>

            <div id="results" style="display: none;">
                <div class="results-section">
                    <div class="results-header">
                        <h2>AI 分析結果</h2>
                        <div class="download-actions">
                            <button onclick="downloadMarkdown()" class="download-btn">
                                <span>📄 下載 Markdown</span>
                            </button>
                            <button onclick="downloadPDF()" class="download-btn">
                                <span>📋 下載 PDF</span>
                            </button>
                        </div>
                    </div>
                    <div id="analysisContent" class="analysis-content"></div>
                </div>
            </div>

            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>AI 正在分析您的檔案，請稍候...</p>
            </div>
        </main>
    </div>

    <script>
        let currentAnalysisData = null;
        let residentName = '';

        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData();
            const dailyLogFile = document.getElementById('daily_log').files[0];
            const carePlanFile = document.getElementById('care_plan').files[0];
            residentName = document.getElementById('resident_name').value;

            if (!dailyLogFile || !carePlanFile || !residentName) {
                alert('請確保所有欄位都已填寫並選擇了檔案');
                return;
            }

            formData.append('daily_log', dailyLogFile);
            formData.append('care_plan', carePlanFile);
            formData.append('resident_name', residentName);

            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';

            // Update button state
            const button = document.querySelector('.analyze-btn');
            const btnText = button.querySelector('.btn-text');
            const btnSpinner = button.querySelector('.btn-spinner');

            button.disabled = true;
            btnText.textContent = '分析中...';
            btnSpinner.style.display = 'inline-block';

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('analysisContent').innerHTML = data.html;
                    currentAnalysisData = data;
                    document.getElementById('results').style.display = 'block';
                } else {
                    alert('分析失敗：' + (data.error || '未知錯誤'));
                }
            } catch (error) {
                console.error('Error occurred:', error);
                alert('發生錯誤：' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';

                // Reset button state
                button.disabled = false;
                btnText.textContent = '開始 AI 分析';
                btnSpinner.style.display = 'none';
            }
        });

        function downloadMarkdown() {
            if (!currentAnalysisData || !currentAnalysisData.markdown) {
                alert('沒有可下載的內容');
                return;
            }

            fetch('/download', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    content: currentAnalysisData.markdown,
                    resident_name: residentName
                })
            })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `Care_Plan_${residentName}_${new Date().toISOString().slice(0,10)}.md`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(error => {
                console.error('Download error:', error);
                alert('下載失敗');
            });
        }

        function downloadPDF() {
            if (!currentAnalysisData || !currentAnalysisData.markdown) {
                alert('沒有可下載的內容');
                return;
            }

            fetch('/download_pdf', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    content: currentAnalysisData.markdown,
                    resident_name: residentName
                })
            })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `Care_Plan_${residentName}_${new Date().toISOString().slice(0,10)}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(error => {
                console.error('PDF download error:', error);
                alert('PDF 下載失敗');
            });
        }
    </script>
</body>
</html>