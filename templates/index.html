<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CarePlanSync - AI Care Plan Analysis</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <div class="brand-container">
                <div class="brand-logo">
                    <svg width="64" height="64" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <!-- Main circle background -->
                        <circle cx="32" cy="32" r="30" fill="url(#gradient1)" stroke="#F08080" stroke-width="2"/>
                        
                        <!-- Heart symbol for care -->
                        <path d="M32 45c-1.5-1.5-12-10.5-12-18 0-4.5 3.5-8 8-8 2.5 0 4.5 1 6 2.5C35.5 19 37.5 18 40 18c4.5 0 8 3.5 8 8 0 7.5-10.5 16.5-12 18z" fill="white" stroke="#F08080" stroke-width="1.5"/>
                        
                        <!-- Medical cross -->
                        <rect x="29" y="24" width="6" height="16" rx="1" fill="#F08080"/>
                        <rect x="24" y="29" width="16" height="6" rx="1" fill="#F08080"/>
                        
                        <!-- Sync arrows -->
                        <path d="M18 15 L22 11 L22 13 L28 13 L28 17 L22 17 L22 19 Z" fill="#FFC07F" opacity="0.8"/>
                        <path d="M46 49 L42 53 L42 51 L36 51 L36 47 L42 47 L42 45 Z" fill="#FFC07F" opacity="0.8"/>
                        
                        <!-- Data dots -->
                        <circle cx="12" cy="32" r="2" fill="#A5CBAF"/>
                        <circle cx="52" cy="32" r="2" fill="#A5CBAF"/>
                        <circle cx="32" cy="12" r="2" fill="#A5CBAF"/>
                        <circle cx="32" cy="52" r="2" fill="#A5CBAF"/>
                        
                        <defs>
                            <linearGradient id="gradient1" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#FEF2F3;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#FADADD;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
                <div class="brand-text">
                    <h1>CarePlanSync</h1>
                    <div class="brand-accent"></div>
                </div>
            </div>
            <p>Upload resident logs and current care plan. AI will analyze and provide optimization suggestions.</p>
        </header>

        <main>
            <!-- Step 1: File Upload -->
            <form id="uploadForm" class="upload-section">
                <div class="form-group">
                    <label for="resident_name">Resident Name:</label>
                    <input type="text" id="resident_name" name="resident_name" placeholder="Enter resident name" required oninvalid="this.setCustomValidity('Please enter resident name')" oninput="this.setCustomValidity('')">
                </div>

                <div class="upload-grid">
                    <div class="upload-box">
                        <h3>Monthly Care Log</h3>
                        <input type="file" id="daily_log" name="daily_log" accept=".csv,.txt,.pdf" required oninvalid="this.setCustomValidity('Please select a care log file')" oninput="this.setCustomValidity('')">
                        <label for="daily_log" class="file-label">
                            <span>Click to select log file</span>
                        </label>
                        <p class="file-info">Supports CSV, TXT, and PDF files<br><small>For best results, use CSV format. PDF support is limited to text-based tables.</small></p>
                    </div>

                    <div class="upload-box">
                        <h3>Current Care Plan</h3>
                        <input type="file" id="care_plan" name="care_plan" accept=".csv,.txt,.pdf" required oninvalid="this.setCustomValidity('Please select a care plan file')" oninput="this.setCustomValidity('')">
                        <label for="care_plan" class="file-label">
                            <span>Click to select care plan</span>
                        </label>
                        <p class="file-info">Supports CSV, TXT, and PDF files<br><small>For best results, use CSV format. PDF support is limited to text-based tables.</small></p>
                    </div>
                </div>

                <button type="submit" class="analyze-btn">üìä Analyze & Get Suggestions</button>
            </form>

            <!-- Loading -->
            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>AI is analyzing files, please wait...</p>
            </div>

            <!-- Step 2: Suggestion Selection -->
            <div id="suggestions" class="results-section" style="display: none;">
                <h2>üìã Care Plan Update Suggestions</h2>

                <div id="analysisSummary" class="analysis-summary"></div>

                <div class="suggestions-container">
                    <h3>üìã Select suggestions to implement:</h3>
                    <div id="suggestionsList"></div>

                    <div class="manager-comments">
                        <h4>üí¨ Additional Comments/Suggestions:</h4>
                        <textarea id="managerComments" placeholder="Add your own observations or modifications..."></textarea>
                    </div>

                    <button id="generatePlanBtn" class="analyze-btn">‚úÖ Generate Updated Care Plan</button>
                </div>
            </div>

            <!-- Step 3: Final Care Plan -->
            <div id="finalPlan" class="results-section" style="display: none;">
                <div class="results-header">
                    <h2>üìÑ Updated Care Plan</h2>
                    <div class="action-buttons">
                        <button id="copyContentBtn" class="action-btn">üìã Copy Content</button>
                        <button id="editBtn" class="action-btn">‚úèÔ∏è Edit Plan</button>
                        <button id="addToCalendarBtn" class="action-btn">üìÖ Add Review to Calendar</button>
                        <div class="email-dropdown">
                            <button id="emailBtn" class="action-btn dropdown-toggle">üìß Email Plan ‚ñº</button>
                            <div class="email-options">
                                <button id="emailCareTeamBtn" class="email-option">üë• Email Care Team</button>
                                <button id="emailFamilyBtn" class="email-option">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Email Family</button>
                            </div>
                        </div>
                        <button id="downloadBtn" class="action-btn">üì• Download PDF</button>
                        <button id="startOverBtn" class="action-btn">üîÑ Start Over</button>
                    </div>
                </div>
                <div id="carePlanContent" class="content"></div>
            </div>


        </main>
    </div>

    <script>
        let currentData = {};

        // File upload handlers
        document.getElementById('daily_log').addEventListener('change', function(e) {
            updateFileLabel(this, 'Click to select log file');
        });

        document.getElementById('care_plan').addEventListener('change', function(e) {
            updateFileLabel(this, 'Click to select care plan');
        });

        function updateFileLabel(input, defaultText) {
            const label = input.nextElementSibling.querySelector('span');
            label.textContent = input.files.length > 0 ? input.files[0].name : defaultText;
        }

        // Step 1: Upload and analyze
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Check if files are selected
            const residentName = document.getElementById('resident_name').value.trim();
            const dailyLogFile = document.getElementById('daily_log').files[0];
            const carePlanFile = document.getElementById('care_plan').files[0];

            if (!residentName) {
                alert('Please enter resident name');
                return;
            }

            if (!dailyLogFile) {
                alert('Please select a care log file');
                return;
            }

            if (!carePlanFile) {
                alert('Please select a care plan file');
                return;
            }

            const analyzeBtn = document.querySelector('.analyze-btn');
            const originalBtnText = analyzeBtn.innerHTML;
            
            // Show loading state immediately
            analyzeBtn.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <div class="btn-spinner"></div>
                    <span>ü§ñ Analyzing...</span>
                </div>
            `;
            analyzeBtn.disabled = true;

            const loading = document.getElementById('loading');
            const suggestions = document.getElementById('suggestions');
            const finalPlan = document.getElementById('finalPlan');

            // Hide all sections
            suggestions.style.display = 'none';
            finalPlan.style.display = 'none';
            loading.style.display = 'block';

            try {
                const formData = new FormData(this);
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.success && data.step === 'suggestions') {
                    currentData = data;
                    displaySuggestions(data);
                    suggestions.style.display = 'block';
                } else {
                    alert('Analysis failed: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error occurred:', error);
                alert('Error occurred: ' + error.message);
            } finally {
                loading.style.display = 'none';
                // Restore button state
                analyzeBtn.innerHTML = originalBtnText;
                analyzeBtn.disabled = false;
            }
        });

        function displaySuggestions(data) {
            // Display analysis summary with icon
            let summaryHtml = `
                <h4>üîç Analysis Summary:</h4>
                <p>${data.analysis_summary}</p>
            `;

            // Add care plan gaps alert if present
            if (data.care_plan_gaps && data.care_plan_gaps.description) {
                const alertClass = data.care_plan_gaps.alert_level === 'High' ? 'gap-alert-high' : 
                                 data.care_plan_gaps.alert_level === 'Medium' ? 'gap-alert-medium' : 'gap-alert-low';
                
                summaryHtml += `
                    <div class="care-plan-gap-alert ${alertClass}">
                        <h4>‚ö†Ô∏è Care Plan Gap Alert - ${data.care_plan_gaps.alert_level} Priority</h4>
                        <p><strong>Gap Description:</strong> ${data.care_plan_gaps.description}</p>
                        <div class="missing-areas">
                            <strong>Missing Areas:</strong>
                            <ul>
                                ${data.care_plan_gaps.missing_areas.map(area => `<li>${area}</li>`).join('')}
                            </ul>
                        </div>
                        <p class="gap-action"><strong>Action Required:</strong> Manager must review and update care plan to address these gaps immediately.</p>
                    </div>
                `;
            }

            document.getElementById('analysisSummary').innerHTML = summaryHtml;

            // Display suggestions with specific issues and dynamic options
            const suggestionsList = document.getElementById('suggestionsList');
            suggestionsList.innerHTML = '';

            if (!data.suggestions || data.suggestions.length === 0) {
                suggestionsList.innerHTML = '<p>No suggestions found in the analysis.</p>';
                return;
            }

            data.suggestions.forEach((suggestion, index) => {
                const issueIcon = suggestion.icon || 'üìã';
                const specificIssue = suggestion.specific_issue || suggestion.suggestion || 'Care Issue';
                const description = suggestion.description || suggestion.reason || 'No description available';
                
                const div = document.createElement('div');
                div.className = 'suggestion-card';
                div.innerHTML = `
                    <div class="suggestion-header priority-${suggestion.priority ? suggestion.priority.toLowerCase() : 'medium'}" onclick="toggleSuggestion(${index})">
                        <div class="what-section">
                            <span class="priority priority-${suggestion.priority ? suggestion.priority.toLowerCase() : 'medium'}">${suggestion.priority || 'Medium'}</span>
                            <strong>${issueIcon} ${specificIssue}</strong>
                            <p class="problem-statement">${description}</p>
                        </div>
                        <span class="expand-icon">‚ñº</span>
                    </div>

                    <div id="suggestion-details-${index}" class="suggestion-details" style="display: none;">
                        <div class="why-section">
                            <h4>ü§î Possible Reasons (select all that apply):</h4>
                            <div class="checkbox-group">
                                ${generateReasonCheckboxes(suggestion.possible_reasons || [], index)}
                                <label class="custom-reason">
                                    <input type="checkbox" name="reason-${index}" value="custom"> Other: 
                                    <input type="text" name="custom-reason-${index}" placeholder="Specify custom reason">
                                </label>
                            </div>
                        </div>

                        <div class="how-section">
                            <h4>‚úÖ Suggested Interventions (select all that apply):</h4>
                            <div class="checkbox-group">
                                ${generateInterventionCheckboxes(suggestion.suggested_interventions || [], index)}
                                <label class="custom-intervention">
                                    <input type="checkbox" name="intervention-${index}" value="custom"> Custom: 
                                    <input type="text" name="custom-intervention-${index}" placeholder="Specify custom intervention">
                                </label>
                            </div>
                        </div>

                        <div class="include-section">
                            <div class="flag-and-include">
                                <label class="flag-suggestion">
                                    <input type="checkbox" name="flag-suggestion" value="${index}">
                                    <span class="flag-icon">üö©</span> <strong>Flag for Priority Follow-up</strong>
                                </label>
                                <label class="include-suggestion">
                                    <input type="checkbox" name="include-suggestion" value="${index}">
                                    <strong>Include this issue in final care plan</strong>
                                </label>
                            </div>
                        </div>
                    </div>
                `;
                suggestionsList.appendChild(div);
            });
        }

        function generateReasonCheckboxes(reasons, index) {
            return reasons.map((reason, i) => 
                `<label><input type="checkbox" name="reason-${index}" value="${i}"> ${reason}</label>`
            ).join('');
        }

        function generateInterventionCheckboxes(interventions, index) {
            return interventions.map((intervention, i) => 
                `<label><input type="checkbox" name="intervention-${index}" value="${i}"> ${intervention}</label>`
            ).join('');
        }

        function toggleSuggestion(index) {
            const details = document.getElementById(`suggestion-details-${index}`);
            const icon = details.previousElementSibling.querySelector('.expand-icon');

            if (details.style.display === 'none') {
                details.style.display = 'block';
                icon.textContent = '‚ñ≤';
            } else {
                details.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        }

        // Generate care plan functionality
        document.getElementById('generatePlanBtn').addEventListener('click', async function() {
            const generateBtn = this;
            const originalBtnText = generateBtn.innerHTML;
            
            // Show loading state immediately
            generateBtn.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <div class="btn-spinner"></div>
                    <span>‚úèÔ∏è Generating...</span>
                </div>
            `;
            generateBtn.disabled = true;

            const loading = document.getElementById('loading');
            const finalPlan = document.getElementById('finalPlan');

            loading.style.display = 'block';

            try {
                // Collect selected suggestions with WHAT-WHY-HOW data and flag status
                const selectedSuggestions = [];

                document.querySelectorAll('input[name="include-suggestion"]:checked').forEach(checkbox => {
                    const index = parseInt(checkbox.value);
                    const suggestion = currentData.suggestions[index];

                    if (!suggestion) return;

                    // Check if this item is flagged
                    const isFlagged = document.querySelector(`input[name="flag-suggestion"][value="${index}"]`).checked;

                    // Collect WHY data (reasons)
                    const reasons = [];
                    const reasonCheckboxes = document.querySelectorAll(`input[name="reason-${index}"]:checked`);
                    reasonCheckboxes.forEach(cb => {
                        if (cb.value === 'custom') {
                            const customReason = document.querySelector(`input[name="custom-reason-${index}"]`).value;
                            if (customReason) reasons.push(customReason);
                        } else {
                            const reasonIndex = parseInt(cb.value);
                            if (suggestion.possible_reasons && suggestion.possible_reasons[reasonIndex]) {
                                reasons.push(suggestion.possible_reasons[reasonIndex]);
                            }
                        }
                    });

                    // Collect HOW data (interventions)
                    const interventions = [];
                    const interventionCheckboxes = document.querySelectorAll(`input[name="intervention-${index}"]:checked`);
                    interventionCheckboxes.forEach(cb => {
                        if (cb.value === 'custom') {
                            const customIntervention = document.querySelector(`input[name="custom-intervention-${index}"]`).value;
                            if (customIntervention) interventions.push(customIntervention);
                        } else {
                            const interventionIndex = parseInt(cb.value);
                            if (suggestion.suggested_interventions && suggestion.suggested_interventions[interventionIndex]) {
                                interventions.push(suggestion.suggested_interventions[interventionIndex]);
                            }
                        }
                    });

                    selectedSuggestions.push({
                        ...suggestion,
                        reasons: reasons,
                        interventions: interventions,
                        flagged: isFlagged
                    });
                });

                const managerComments = document.getElementById('managerComments').value || '';

                console.log('Sending data:', {
                    original_care_plan: currentData.original_care_plan,
                    selected_suggestions: selectedSuggestions,
                    manager_comments: managerComments,
                    resident_name: currentData.resident_name
                });

                const response = await fetch('/generate_care_plan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        original_care_plan: currentData.original_care_plan,
                        selected_suggestions: selectedSuggestions,
                        manager_comments: managerComments,
                        resident_name: currentData.resident_name
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Response data:', data);

                if (data.success) {
                    document.getElementById('carePlanContent').innerHTML = data.care_plan.html;
                    finalPlan.style.display = 'block';

                    // Store for download
                    window.currentReport = {
                        content: data.care_plan.markdown,
                        resident_name: currentData.resident_name
                    };

                    // Scroll to results
                    finalPlan.scrollIntoView({ behavior: 'smooth' });
                } else {
                    alert('Care plan generation failed: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error in generate care plan:', error);
                alert('Error occurred: ' + error.message);
            } finally {
                loading.style.display = 'none';
                // Restore button state
                generateBtn.innerHTML = originalBtnText;
                generateBtn.disabled = false;
            }
        });

        // Copy content functionality (copies HTML content)
        document.getElementById('copyContentBtn').addEventListener('click', function() {
            const content = document.getElementById('carePlanContent');
            if (content) {
                const range = document.createRange();
                range.selectNode(content);
                window.getSelection().removeAllRanges();
                window.getSelection().addRange(range);
                document.execCommand('copy');
                window.getSelection().removeAllRanges();
                alert('Care plan content copied to clipboard!');
            }
        });

        // Edit functionality
        document.getElementById('editBtn').addEventListener('click', function() {
            if (window.currentReport) {
                const content = document.getElementById('carePlanContent');
                const currentHtml = content.innerHTML;
                
                // Convert to editable
                content.innerHTML = `
                    <div class="edit-container">
                        <textarea id="editableContent" style="width: 100%; min-height: 400px; padding: 15px; border: 1px solid #ddd; border-radius: 6px; font-family: inherit; font-size: 14px; line-height: 1.6;">${window.currentReport.content}</textarea>
                        <div style="margin-top: 15px; text-align: right;">
                            <button id="cancelEdit" class="action-btn" style="margin-right: 10px;">Cancel</button>
                            <button id="saveEdit" class="action-btn primary">Save Changes</button>
                        </div>
                    </div>
                `;
                
                // Cancel edit
                document.getElementById('cancelEdit').addEventListener('click', function() {
                    content.innerHTML = currentHtml;
                });
                
                // Save edit
                document.getElementById('saveEdit').addEventListener('click', function() {
                    const newContent = document.getElementById('editableContent').value;
                    window.currentReport.content = newContent;
                    
                    // Convert back to HTML display
                    const converter = new showdown.Converter();
                    content.innerHTML = converter.makeHtml(newContent);
                    
                    alert('Changes saved successfully!');
                });
            }
        });

        // Email dropdown toggle
        document.getElementById('emailBtn').addEventListener('click', function(e) {
            e.preventDefault();
            const dropdown = this.parentElement;
            const options = dropdown.querySelector('.email-options');
            const isVisible = options.style.display === 'block';
            
            // Hide all other dropdowns first
            document.querySelectorAll('.email-options').forEach(opt => opt.style.display = 'none');
            
            options.style.display = isVisible ? 'none' : 'block';
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.email-dropdown')) {
                document.querySelectorAll('.email-options').forEach(opt => opt.style.display = 'none');
            }
        });

        // Google Calendar functionality
        document.getElementById('addToCalendarBtn').addEventListener('click', function() {
            if (window.currentReport) {
                // Calculate next review date (30 days from today)
                const today = new Date();
                const reviewDate = new Date(today.getTime() + (30 * 24 * 60 * 60 * 1000));
                
                // Format dates for Google Calendar
                const startDate = reviewDate.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                const endDate = new Date(reviewDate.getTime() + (60 * 60 * 1000)).toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z'; // 1 hour duration
                
                // Extract priority items from care plan for event description
                const content = window.currentReport.content;
                let priorityItems = [];
                
                // Look for flagged items or high priority sections
                if (content.includes('üö© Priority Observation Areas') || content.includes('Priority Flagged Items')) {
                    const prioritySection = content.match(/üö©\s*Priority[^#]*?(?=##|$)/g);
                    if (prioritySection) {
                        prioritySection.forEach(section => {
                            const lines = section.split('\n');
                            lines.forEach(line => {
                                if (line.includes('üö©') && line.trim().length > 5) {
                                    priorityItems.push(line.replace(/üö©/g, '').trim());
                                }
                            });
                        });
                    }
                }
                
                // Build event description
                let eventDescription = `Care Plan Review for ${window.currentReport.resident_name}\\n\\n`;
                eventDescription += `üìã REVIEW CHECKLIST:\\n`;
                eventDescription += `‚Ä¢ Assess progress on current care interventions\\n`;
                eventDescription += `‚Ä¢ Review resident's response to care plan changes\\n`;
                eventDescription += `‚Ä¢ Update care strategies based on observations\\n`;
                eventDescription += `‚Ä¢ Document any new concerns or improvements\\n\\n`;
                
                if (priorityItems.length > 0) {
                    eventDescription += `üö© PRIORITY AREAS TO REVIEW:\\n`;
                    priorityItems.slice(0, 5).forEach(item => {
                        eventDescription += `‚Ä¢ ${item}\\n`;
                    });
                    eventDescription += `\\n`;
                }
                
                eventDescription += `üìû Attendees: Care Manager, Nursing Supervisor, Primary Care Staff\\n`;
                eventDescription += `üìÑ Bring: Updated care plan document\\n`;
                eventDescription += `‚è∞ Duration: 60 minutes`;
                
                // Google Calendar URL
                const calendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(`Care Plan Review - ${window.currentReport.resident_name}`)}&dates=${startDate}/${endDate}&details=${encodeURIComponent(eventDescription)}&location=${encodeURIComponent('Care Facility - Conference Room')}&ctz=Asia/Hong_Kong`;
                
                window.open(calendarUrl, '_blank');
            }
        });

        // Enhanced Email to Care Team functionality with dynamic content
        document.getElementById('emailCareTeamBtn').addEventListener('click', function() {
            if (window.currentReport) {
                const content = window.currentReport.content;
                
                // Extract different types of updates dynamically
                const updates = extractCareplanUpdates(content);
                
                const subject = encodeURIComponent(`URGENT: Care Plan Update - ${window.currentReport.resident_name} (${updates.highPriorityCount} Priority Items)`);
                
                // Generate dynamic email body based on care plan content
                let emailBody = generateCareTeamEmail(window.currentReport.resident_name, updates);
                
                const body = encodeURIComponent(emailBody);
                const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=&su=${subject}&body=${body}`;
                window.open(gmailUrl, '_blank');
            }
            
            // Hide dropdown
            document.querySelector('.email-options').style.display = 'none';
        });

        // Function to extract care plan updates dynamically
        function extractCareplanUpdates(content) {
            const updates = {
                personalCare: [],
                health: [],
                behavioral: [],
                nutrition: [],
                mobility: [],
                communication: [],
                flaggedItems: [],
                newInterventions: [],
                monitoringRequirements: [],
                highPriorityCount: 0,
                mediumPriorityCount: 0
            };
            
            const lines = content.split('\n');
            let currentSection = '';
            let currentUpdate = null;
            
            lines.forEach(line => {
                line = line.trim();
                
                // Identify sections
                if (line.includes('Personal Care') || line.includes('ÂÄã‰∫∫Ë≠∑ÁêÜ')) {
                    currentSection = 'personalCare';
                } else if (line.includes('Health') || line.includes('Medication') || line.includes('ÂÅ•Â∫∑')) {
                    currentSection = 'health';
                } else if (line.includes('Behavior') || line.includes('Ë°åÁÇ∫')) {
                    currentSection = 'behavioral';
                } else if (line.includes('Nutrition') || line.includes('Eating') || line.includes('ÁáüÈ§ä')) {
                    currentSection = 'nutrition';
                } else if (line.includes('Mobility') || line.includes('Ê¥ªÂãï')) {
                    currentSection = 'mobility';
                } else if (line.includes('Communication') || line.includes('Ê∫ùÈÄö')) {
                    currentSection = 'communication';
                }
                
                // Look for flagged items
                if (line.includes('üö©')) {
                    updates.flaggedItems.push(line.replace(/üö©/g, '').trim());
                    updates.highPriorityCount++;
                }
                
                // Look for new content markers
                if (line.includes('‚úèÔ∏è')) {
                    const updateText = line.replace(/‚úèÔ∏è/g, '').replace(/[#*]/g, '').trim();
                    if (updateText && currentSection) {
                        updates[currentSection].push(updateText);
                    }
                    if (line.toLowerCase().includes('high') || line.includes('urgent')) {
                        updates.highPriorityCount++;
                    } else {
                        updates.mediumPriorityCount++;
                    }
                }
                
                // Look for action items
                if (line.startsWith('‚Ä¢') && (line.includes('monitor') || line.includes('observe') || line.includes('track'))) {
                    updates.monitoringRequirements.push(line.replace('‚Ä¢', '').trim());
                }
                
                // Look for new interventions
                if (line.startsWith('‚Ä¢') && (line.includes('implement') || line.includes('provide') || line.includes('ensure'))) {
                    updates.newInterventions.push(line.replace('‚Ä¢', '').trim());
                }
            });
            
            return updates;
        }

        // Function to generate dynamic care team email
        function generateCareTeamEmail(residentName, updates) {
            const urgencyLevel = updates.highPriorityCount > 2 ? 'CRITICAL' : updates.highPriorityCount > 0 ? 'HIGH' : 'MODERATE';
            const reviewDate = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toLocaleDateString();
            
            let emailBody = `üö® ${urgencyLevel} PRIORITY: Care Plan Update Required

Dear Care Team,

The care plan for ${residentName} has been updated and requires IMMEDIATE attention and implementation.

üìä UPDATE SUMMARY:
‚Ä¢ ${updates.highPriorityCount} High Priority Changes
‚Ä¢ ${updates.mediumPriorityCount} Standard Updates
‚Ä¢ ${updates.flaggedItems.length} Items Flagged for Special Monitoring
‚Ä¢ Next Review Date: ${reviewDate}

`;

            // Add flagged items section
            if (updates.flaggedItems.length > 0) {
                emailBody += `üö© CRITICAL MONITORING REQUIRED:\n`;
                updates.flaggedItems.slice(0, 5).forEach((item, index) => {
                    emailBody += `${index + 1}. ${item}\n`;
                });
                emailBody += `\n`;
            }

            // Add category-specific updates
            const categories = [
                { key: 'personalCare', name: 'ÂÄã‰∫∫Ë≠∑ÁêÜ Personal Care', icon: 'üöø' },
                { key: 'health', name: 'ÂÅ•Â∫∑ÈÜ´ÁôÇ Health & Medication', icon: 'üíä' },
                { key: 'behavioral', name: 'Ë°åÁÇ∫ÊîØÊè¥ Behavioral Support', icon: 'üß†' },
                { key: 'nutrition', name: 'ÁáüÈ§äÈ£≤È£ü Nutrition & Hydration', icon: 'üçΩÔ∏è' },
                { key: 'mobility', name: 'Ê¥ªÂãïËÉΩÂäõ Mobility & Safety', icon: 'üö∂' },
                { key: 'communication', name: 'Ê∫ùÈÄö‰∫§ÊµÅ Communication', icon: 'üó£Ô∏è' }
            ];

            let hasUpdates = false;
            categories.forEach(category => {
                if (updates[category.key] && updates[category.key].length > 0) {
                    if (!hasUpdates) {
                        emailBody += `üìã SPECIFIC CARE AREA UPDATES:\n\n`;
                        hasUpdates = true;
                    }
                    emailBody += `${category.icon} ${category.name}:\n`;
                    updates[category.key].slice(0, 3).forEach(update => {
                        emailBody += `   ‚Ä¢ ${update}\n`;
                    });
                    emailBody += `\n`;
                }
            });

            // Add new interventions
            if (updates.newInterventions.length > 0) {
                emailBody += `üéØ NEW INTERVENTIONS TO IMPLEMENT:\n`;
                updates.newInterventions.slice(0, 5).forEach((intervention, index) => {
                    emailBody += `${index + 1}. ${intervention}\n`;
                });
                emailBody += `\n`;
            }

            // Add monitoring requirements
            if (updates.monitoringRequirements.length > 0) {
                emailBody += `üëÅÔ∏è ENHANCED MONITORING REQUIREMENTS:\n`;
                updates.monitoringRequirements.slice(0, 5).forEach((requirement, index) => {
                    emailBody += `${index + 1}. ${requirement}\n`;
                });
                emailBody += `\n`;
            }

            emailBody += `üìã IMMEDIATE ACTION REQUIRED:
‚úÖ Review complete updated care plan (attached)
‚úÖ Brief ALL care staff on new procedures before next shift
‚úÖ Update care documentation systems
‚úÖ Implement new interventions immediately
‚úÖ Begin enhanced monitoring protocols
‚úÖ Schedule team meeting if high priority items exist

‚è∞ IMPLEMENTATION TIMELINE:
‚Ä¢ Review: Within 2 hours of receiving this email
‚Ä¢ Staff briefing: Before next shift handover
‚Ä¢ Implementation: Start immediately
‚Ä¢ Documentation: Update within 24 hours
‚Ä¢ Follow-up review: ${reviewDate}

üìû ESCALATION PROTOCOL:
‚Ä¢ Questions: Contact Nursing Supervisor immediately
‚Ä¢ Concerns: Notify Care Manager
‚Ä¢ Emergencies: Follow standard emergency procedures

üéØ SUCCESS METRICS:
‚Ä¢ All staff briefed and signed off on changes
‚Ä¢ New interventions documented in care logs
‚Ä¢ Resident response monitored and recorded
‚Ä¢ Any issues or improvements noted for next review

Generated by CarePlanSync AI System
Timestamp: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}
Urgency Level: ${urgencyLevel}

üìÑ Complete care plan document attached for detailed reference.`;

            return emailBody;
        }

        // Enhanced Email to Family functionality with dynamic content
        document.getElementById('emailFamilyBtn').addEventListener('click', function() {
            if (window.currentReport) {
                const content = window.currentReport.content;
                const updates = extractCareplanUpdates(content);
                
                const subject = encodeURIComponent(`${window.currentReport.resident_name}ÁöÑË≠∑ÁêÜË®àÂäÉÊõ¥Êñ∞ Care Plan Update`);
                
                // Generate dynamic family email
                let emailBody = generateFamilyEmail(window.currentReport.resident_name, updates, content);
                
                const body = encodeURIComponent(emailBody);
                const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=&su=${subject}&body=${body}`;
                window.open(gmailUrl, '_blank');
            }
            
            // Hide dropdown
            document.querySelector('.email-options').style.display = 'none';
        });

        // Function to generate dynamic family email
        function generateFamilyEmail(residentName, updates, content) {
            const reviewDate = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toLocaleDateString();
            
            let emailBody = `Ë¶™ÊÑõÁöÑÂÆ∂‰∫∫ Dear Family,

ÊàëÂÄëÂ∏åÊúõÊÇ®‰∏ÄÂàáÂÆâÂ•Ω„ÄÇÊàëÂÄëÊÉ≥ÂêëÊÇ®ÂåØÂ†±${residentName}ÁöÑË≠∑ÁêÜË®àÂäÉÊõ¥Êñ∞ÊÉÖÊ≥ÅÔºå‰∏¶Ë™†ÊëØÂú∞Â∏åÊúõËÅΩÂèñÊÇ®ÂØ∂Ë≤¥ÁöÑÊÑèË¶ã„ÄÇ

We hope this message finds you well. We wanted to update you on ${residentName}'s care plan and seek your valuable input.

üè• Ë≠∑ÁêÜË®àÂäÉÊõ¥Êñ∞ CARE PLAN UPDATES:

ÊàëÂÄëÁöÑË≠∑ÁêÜÂúòÈöä‰∏ÄÁõ¥ÂØÜÂàáÈóúÊ≥®${residentName}ÁöÑÊÉÖÊ≥ÅÔºå‰∏¶Ë≠òÂà•Âá∫‰∏Ä‰∫õÂèØ‰ª•ÊèêÂçáË≠∑ÁêÜË≥™ÈáèÁöÑÁØÑÁñáÔºö
Our care team has been closely monitoring ${residentName} and has identified areas where we can enhance their care experience:

`;

            // Add positive progress if any
            if (content.includes('improvement') || content.includes('progress') || content.includes('better')) {
                emailBody += `üåü Â•ΩÊ∂àÊÅØ POSITIVE DEVELOPMENTS:\n`;
                emailBody += `ÊàëÂÄëÂæàÈ´òËààÂú∞Â†±Âëä${residentName}Âú®‰∏Ä‰∫õÊñπÈù¢ÊúâÊâÄÈÄ≤Â±ï„ÄÇ\n`;
                emailBody += `We're pleased to report that ${residentName} has shown progress in several areas.\n\n`;
            }

            // Add care area updates in family-friendly language
            const familyFriendlyCategories = [
                { 
                    key: 'personalCare', 
                    name: 'ÂÄã‰∫∫Ë≠∑ÁêÜ Personal Care', 
                    description: 'ÊàëÂÄëÊ≠£Âú®Ë™øÊï¥Êó•Â∏∏Ë≠∑ÁêÜÁ®ãÂ∫è‰ª•Êõ¥Â•ΩÂú∞ÊªøË∂≥${residentName}ÁöÑÈúÄË¶Å'
                },
                { 
                    key: 'health', 
                    name: 'ÂÅ•Â∫∑ÁÆ°ÁêÜ Health Management', 
                    description: 'ÊàëÂÄëÊ≠£Âú®ÂÑ™ÂåñÂÅ•Â∫∑Áõ£Ë≠∑ÂíåÈÜ´ÁôÇË≠∑ÁêÜÂÆâÊéí'
                },
                { 
                    key: 'behavioral', 
                    name: 'ÊÉÖÁ∑íÊîØÊè¥ Emotional Support', 
                    description: 'ÊàëÂÄëÊ≠£Âú®Âä†Âº∑ÊÉÖÁ∑íÂíåË°åÁÇ∫ÊîØÊè¥Á≠ñÁï•'
                },
                { 
                    key: 'nutrition', 
                    name: 'ÁáüÈ§äÈ£≤È£ü Nutrition & Meals', 
                    description: 'ÊàëÂÄëÊ≠£Âú®ÊîπÂñÑÁî®È§êÈ´îÈ©óÂíåÁáüÈ§äÊîùÂèñ'
                },
                { 
                    key: 'mobility', 
                    name: 'Ê¥ªÂãïÂÆâÂÖ® Mobility & Safety', 
                    description: 'ÊàëÂÄëÊ≠£Âú®ÂÑ™ÂåñÊ¥ªÂãïÂÆâÊéíÂíåÂÆâÂÖ®Êé™ÊñΩ'
                },
                { 
                    key: 'communication', 
                    name: 'Ê∫ùÈÄö‰∫§ÊµÅ Communication', 
                    description: 'ÊàëÂÄëÊ≠£Âú®ÊîπÂñÑÊ∫ùÈÄöÊñπÂºèÂíåÁ§æ‰∫§‰∫íÂãï'
                }
            ];

            let hasSpecificUpdates = false;
            familyFriendlyCategories.forEach((category, index) => {
                if (updates[category.key] && updates[category.key].length > 0) {
                    if (!hasSpecificUpdates) {
                        emailBody += `üìã ÂÖ∑È´îÊõ¥Êñ∞ÁØÑÁñá SPECIFIC UPDATE AREAS:\n\n`;
                        hasSpecificUpdates = true;
                    }
                    emailBody += `${index + 1}. ${category.name}\n`;
                    emailBody += `   ${category.description.replace('${residentName}', residentName)}\n`;
                    
                    // Add 1-2 specific items in gentle language
                    const gentleUpdates = updates[category.key].slice(0, 2).map(update => {
                        return update.replace(/urgent|immediate|critical/gi, 'enhanced')
                                    .replace(/monitor closely/gi, 'pay special attention to')
                                    .replace(/implement/gi, 'introduce');
                    });
                    
                    gentleUpdates.forEach(update => {
                        emailBody += `   ‚Ä¢ ${update}\n`;
                    });
                    emailBody += `\n`;
                }
            });

            // Add comfort and reassurance section
            emailBody += `ü§ó Ë´ãÊîæÂøÉ PLEASE BE ASSURED:

‚Ä¢ ÊâÄÊúâËÆäÊõ¥ÈÉΩÊòØÁÇ∫‰∫ÜÊèêÂçá${residentName}ÁöÑËàíÈÅ©Â∫¶ÂíåÁîüÊ¥ªÂìÅË≥™
‚Ä¢ All changes are designed to enhance ${residentName}'s comfort and quality of life
‚Ä¢ ÊàëÂÄëÁöÑÂ∞àÊ•≠ÂúòÈöäÊúÉÂØÜÂàáÁõ£ÂØüË≠∑ÁêÜÊïàÊûú
‚Ä¢ Our professional team will closely monitor the effectiveness of care
‚Ä¢ ${residentName}ÁöÑÂÆâÂÖ®ÂíåÁ¶èÁ•âÂßãÁµÇÊòØÊàëÂÄëÁöÑÈ¶ñË¶ÅËÄÉÊÖÆ
‚Ä¢ ${residentName}'s safety and wellbeing remain our top priority

üí≠ ÊàëÂÄëÈáçË¶ñÊÇ®ÁöÑÊÑèË¶ã WE VALUE YOUR INPUT:

ÊÇ®Â∞ç${residentName}ÁöÑÁû≠Ëß£Â∞çÊàëÂÄë‰æÜË™™ÈùûÂ∏∏ÂØ∂Ë≤¥„ÄÇË´ãÂàÜ‰∫´Ôºö
Your insights about ${residentName} are invaluable to us. Please share:

‚Ä¢ Â∞çÈÄô‰∫õÊõ¥Êñ∞ÁöÑ‰ªª‰ΩïÁñëÂïèÊàñÈóúÊ≥® Any concerns or questions about these updates
‚Ä¢ ÊÇ®Â∞ç${residentName}ÂñúÂ•ΩÁöÑËßÄÂØü Your observations about ${residentName}'s preferences  
‚Ä¢ Âü∫ÊñºÂÆ∂Â∫≠Á∂ìÈ©óÁöÑÂª∫Ë≠∞ Suggestions based on family experience
‚Ä¢ ‰ªª‰ΩïÂèØËÉΩÂπ´Âä©ÊàëÂÄëÁöÑËÉåÊôØË≥áË®ä Any background information that might help us
‚Ä¢ ÊÇ®Â∏åÊúõÊàëÂÄëÂ¶Ç‰ΩïËàáÊÇ®Ê∫ùÈÄöÊú™‰æÜÁöÑÊõ¥Êñ∞ How you'd like us to communicate future updates

üìû ‰∏ã‰∏ÄÊ≠• NEXT STEPS:

‰∏ãÊ¨°ÂõûÈ°ßÊó•ÊúüÔºö${reviewDate}
Next review date: ${reviewDate}

Ë´ãÈö®ÊôÇÔºö
Please feel free to:
‚Ä¢ ÂõûË¶ÜÊ≠§ÈõªÈÉµÂàÜ‰∫´ÊÇ®ÁöÑÊÉ≥Ê≥ï Reply to this email with your thoughts
‚Ä¢ Ëá¥Èõª [ÈõªË©±ËôüÁ¢º] Ë®éË´ñ Call us at [PHONE NUMBER] to discuss  
‚Ä¢ ÂÆâÊéíËàáË≠∑ÁêÜÂúòÈöäÊúÉÈù¢ Schedule a meeting with the care team
‚Ä¢ Êé¢Ë®™‰∏¶ËßÄÂØüÊñ∞ÁöÑË≠∑ÁêÜÊñπÂºè Visit and observe the new care approaches

ÊàëÂÄëËá¥ÂäõÊñºËÆìÊÇ®‰∫ÜËß£‰∏¶ÂèÉËàá${residentName}ÁöÑË≠∑ÁêÜÈÅéÁ®ã„ÄÇ
We're committed to keeping you informed and involved in ${residentName}'s care journey.

Ê≠§Ëá¥Êï¨Á¶Æ With warm regards,
Ë≠∑ÁêÜÁÆ°ÁêÜÂúòÈöä The Care Management Team
${new Date().toLocaleDateString()}

ÈôÑË®ªÔºöÂÆåÊï¥ÁöÑË≠∑ÁêÜË®àÂäÉÊñá‰ª∂Â∑≤ÈôÑ‰∏ä‰æõÊÇ®ÂèÉËÄÉ„ÄÇ
P.S. The complete care plan document is attached for your reference.`;

            return emailBody;
        }

        // Download functionality (PDF)
        document.getElementById('downloadBtn').addEventListener('click', async function() {
            if (window.currentReport) {
                try {
                    const response = await fetch('/download_pdf', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(window.currentReport)
                    });

                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `Care_Plan_${window.currentReport.resident_name}_${new Date().getTime()}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                } catch (error) {
                    alert('Download failed: ' + error.message);
                }
            }
        });

        // Start over functionality
        document.getElementById('startOverBtn').addEventListener('click', function() {
            document.getElementById('suggestions').style.display = 'none';
            document.getElementById('finalPlan').style.display = 'none';
            document.getElementById('charts').style.display = 'none';
            document.getElementById('uploadForm').reset();
            updateFileLabel(document.getElementById('daily_log'), 'Click to select log file');
            updateFileLabel(document.getElementById('care_plan'), 'Click to select care plan');
            window.currentReport = null;
            currentData = {};
        });


    </script>
</body>
</html>