
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è­·ç†è¨ˆåŠƒ AI åˆ†æå¹³å°</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¥ è­·ç†è¨ˆåŠƒ AI åˆ†æå¹³å°</h1>
            <p>ä¸Šå‚³ä½æˆ¶æ—¥èªŒå’Œç¾æœ‰è­·ç†è¨ˆåŠƒï¼ŒAI å°‡ç‚ºæ‚¨åˆ†æä¸¦æä¾›å„ªåŒ–å»ºè­°</p>
        </header>

        <main>
            <form id="uploadForm" class="upload-section">
                <div class="form-group">
                    <label for="resident_name">ä½æˆ¶å§“åï¼š</label>
                    <input type="text" id="resident_name" name="resident_name" placeholder="è«‹è¼¸å…¥ä½æˆ¶å§“å" required>
                </div>

                <div class="upload-grid">
                    <div class="upload-box">
                        <h3>ğŸ“‹ æœ¬æœˆæ—¥èªŒè¨˜éŒ„</h3>
                        <input type="file" id="daily_log" name="daily_log" accept=".csv,.txt" required>
                        <label for="daily_log" class="file-label">
                            <span>é»æ“Šé¸æ“‡æª”æ¡ˆæˆ–æ‹–æ”¾åˆ°æ­¤è™•</span>
                        </label>
                        <p class="file-info"></p>
                    </div>

                    <div class="upload-box">
                        <h3>ğŸ“„ ç¾æœ‰è­·ç†è¨ˆåŠƒ</h3>
                        <input type="file" id="care_plan" name="care_plan" accept=".csv,.txt" required>
                        <label for="care_plan" class="file-label">
                            <span>é»æ“Šé¸æ“‡æª”æ¡ˆæˆ–æ‹–æ”¾åˆ°æ­¤è™•</span>
                        </label>
                        <p class="file-info"></p>
                    </div>
                </div>

                <button type="submit" class="analyze-btn">
                    <span>ğŸ¤– é–‹å§‹ AI åˆ†æ</span>
                </button>
            </form>

            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>AI æ­£åœ¨åˆ†æä¸­ï¼Œè«‹ç¨å€™...</p>
            </div>

            <div id="results" class="results-section" style="display: none;">
                <div class="results-header">
                    <h2>åˆ†æå ±å‘Š</h2>
                    <div class="action-buttons">
                        <button id="copyBtn" class="action-btn">ğŸ“‹ è¤‡è£½</button>
                        <button id="downloadBtn" class="action-btn">ğŸ’¾ ä¸‹è¼‰åˆ†æ</button>
                        <button id="downloadCarePlanBtn" class="action-btn">ğŸ“„ ä¸‹è¼‰è­·ç†è¨ˆåŠƒ</button>
                        <button id="printBtn" class="action-btn">ğŸ–¨ï¸ åˆ—å°</button>
                        <button id="exportPdfBtn" class="action-btn">ğŸ“„ åŒ¯å‡ºPDF</button>
                        <button id="newAnalysisBtn" class="action-btn">ğŸ”„ æ–°åˆ†æ</button>
                    </div>
                </div>

                <!-- åˆ†é å°èˆª -->
                <div class="tab-navigation">
                    <button class="tab-btn active" data-tab="overview">ğŸ“Š ç¸½è¦½</button>
                    <button class="tab-btn" data-tab="charts">ğŸ“ˆ åœ–è¡¨</button>
                    <button class="tab-btn" data-tab="analysis">ğŸ“‹ è©³ç´°åˆ†æ</button>
                    <button class="tab-btn" data-tab="incidents">âš ï¸ å•é¡Œæ—¥èªŒ</button>
                    <button class="tab-btn" data-tab="careplan">ğŸ“„ æ–°è­·ç†è¨ˆåŠƒ</button>
                </div>

                <!-- ç¸½è¦½é é¢ -->
                <div id="overview-tab" class="tab-content active">
                    <div class="overview-grid">
                        <div class="overview-card">
                            <h3>ğŸ“Š æœ¬æœˆçµ±è¨ˆ</h3>
                            <div id="monthlyStats"></div>
                        </div>
                        <div class="overview-card">
                            <h3>âš ï¸ é‡è¦æé†’</h3>
                            <div id="importantAlerts"></div>
                        </div>
                    </div>
                </div>

                <!-- åœ–è¡¨é é¢ -->
                <div id="charts-tab" class="tab-content">
                    <div class="charts-grid">
                        <div class="chart-container">
                            <h3>ğŸ’§ é£²æ°´é‡è¶¨å‹¢</h3>
                            <canvas id="waterChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>ğŸš½ æ’ä¾¿æ¬¡æ•¸</h3>
                            <canvas id="bowelChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>ğŸ½ï¸ é€²é£Ÿé‡ç™¾åˆ†æ¯”</h3>
                            <canvas id="foodChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- è©³ç´°åˆ†æé é¢ -->
                <div id="analysis-tab" class="tab-content">
                    <div id="reportContent" class="report-content"></div>
                </div>

                <!-- å•é¡Œæ—¥èªŒé é¢ -->
                <div id="incidents-tab" class="tab-content">
                    <div id="incidentsList" class="incidents-list"></div>
                </div>

                <!-- æ–°è­·ç†è¨ˆåŠƒé é¢ -->
                <div id="careplan-tab" class="tab-content">
                    <div id="carePlanContent" class="care-plan-content"></div>
                </div>
            </div>
        </main>

        <footer>
            <p>Â© 2024 è­·ç†è¨ˆåŠƒ AI åˆ†æå¹³å° | æ‰€æœ‰ä¸Šå‚³è³‡æ–™å°‡åœ¨åˆ†æå¾Œç«‹å³åˆªé™¤</p>
        </footer>
    </div>

    <script>
        let currentData = null;

        // æª”æ¡ˆä¸Šå‚³è™•ç†
        document.querySelectorAll('input[type="file"]').forEach(input => {
            input.addEventListener('change', function(e) {
                const fileName = e.target.files[0]?.name || 'æœªé¸æ“‡æª”æ¡ˆ';
                const fileInfo = e.target.parentElement.querySelector('.file-info');
                fileInfo.textContent = `å·²é¸æ“‡: ${fileName}`;
            });
        });

        // åˆ†é è™•ç†
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tabName = this.dataset.tab;
                
                // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // æ›´æ–°å…§å®¹é¡¯ç¤º
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabName + '-tab').classList.add('active');
            });
        });

        // ç”Ÿæˆåœ–è¡¨
        function createCharts(data) {
            // é£²æ°´é‡åœ–è¡¨
            if (data.water_intake.length > 0) {
                const waterCtx = document.getElementById('waterChart').getContext('2d');
                new Chart(waterCtx, {
                    type: 'line',
                    data: {
                        labels: data.water_intake.map(item => item.date),
                        datasets: [{
                            label: 'é£²æ°´é‡ (ml)',
                            data: data.water_intake.map(item => item.amount),
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // æ’ä¾¿æ¬¡æ•¸åœ–è¡¨
            if (data.bowel_movements.length > 0) {
                const bowelCtx = document.getElementById('bowelChart').getContext('2d');
                new Chart(bowelCtx, {
                    type: 'bar',
                    data: {
                        labels: data.bowel_movements.map(item => item.date),
                        datasets: [{
                            label: 'æ’ä¾¿æ¬¡æ•¸',
                            data: data.bowel_movements.map(item => item.count),
                            backgroundColor: '#e67e22',
                            borderColor: '#d35400',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                stepSize: 1
                            }
                        }
                    }
                });
            }

            // é€²é£Ÿé‡åœ–è¡¨
            if (data.food_intake.length > 0) {
                const foodCtx = document.getElementById('foodChart').getContext('2d');
                new Chart(foodCtx, {
                    type: 'line',
                    data: {
                        labels: data.food_intake.map(item => item.date),
                        datasets: [{
                            label: 'é€²é£Ÿé‡ (%)',
                            data: data.food_intake.map(item => item.percentage),
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
            }
        }

        // é¡¯ç¤ºå•é¡Œæ—¥èªŒ
        function displayIncidents(incidents) {
            const incidentsList = document.getElementById('incidentsList');
            if (incidents.length === 0) {
                incidentsList.innerHTML = '<p class="no-incidents">æœ¬æœŸé–“ç„¡è¨˜éŒ„ç•°å¸¸äº‹ä»¶</p>';
                return;
            }

            const sortedIncidents = incidents.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            incidentsList.innerHTML = sortedIncidents.map(incident => `
                <div class="incident-item ${incident.severity}">
                    <div class="incident-header">
                        <span class="incident-date">${incident.date}</span>
                        <span class="severity-badge ${incident.severity}">
                            ${incident.severity === 'high' ? 'ğŸ”´ é«˜' : 'ğŸŸ¡ ä¸­'}
                        </span>
                    </div>
                    <div class="incident-description">${incident.description}</div>
                </div>
            `).join('');
        }

        // ç”Ÿæˆç¸½è¦½çµ±è¨ˆ
        function generateOverview(data) {
            const avgWater = data.water_intake.length > 0 ? 
                Math.round(data.water_intake.reduce((sum, item) => sum + item.amount, 0) / data.water_intake.length) : 0;
            const avgBowel = data.bowel_movements.length > 0 ? 
                Math.round(data.bowel_movements.reduce((sum, item) => sum + item.count, 0) / data.bowel_movements.length) : 0;
            const avgFood = data.food_intake.length > 0 ? 
                Math.round(data.food_intake.reduce((sum, item) => sum + item.percentage, 0) / data.food_intake.length) : 0;

            document.getElementById('monthlyStats').innerHTML = `
                <div class="stat-item">
                    <span class="stat-label">å¹³å‡é£²æ°´é‡ï¼š</span>
                    <span class="stat-value">${avgWater} ml</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">å¹³å‡æ’ä¾¿æ¬¡æ•¸ï¼š</span>
                    <span class="stat-value">${avgBowel} æ¬¡/æ—¥</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">å¹³å‡é€²é£Ÿé‡ï¼š</span>
                    <span class="stat-value">${avgFood}%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ç•°å¸¸äº‹ä»¶ï¼š</span>
                    <span class="stat-value">${data.incidents.length} é …</span>
                </div>
            `;

            // é‡è¦æé†’
            const alerts = [];
            if (avgWater < 1500) alerts.push('âš ï¸ é£²æ°´é‡åä½ï¼Œéœ€è¦å¢åŠ æ°´åˆ†æ”å–');
            if (avgBowel < 1) alerts.push('âš ï¸ æ’ä¾¿æ¬¡æ•¸åå°‘ï¼Œéœ€è¦é—œæ³¨è…¸é“å¥åº·');
            if (avgFood < 70) alerts.push('âš ï¸ é€²é£Ÿé‡ä¸è¶³ï¼Œéœ€è¦ç‡Ÿé¤Šå¸«è©•ä¼°');
            if (data.incidents.filter(i => i.severity === 'high').length > 0) {
                alerts.push('ğŸš¨ æœ‰é«˜åš´é‡æ€§äº‹ä»¶éœ€è¦ç«‹å³è™•ç†');
            }

            document.getElementById('importantAlerts').innerHTML = alerts.length > 0 ? 
                alerts.map(alert => `<div class="alert-item">${alert}</div>`).join('') :
                '<div class="no-alerts">âœ… ç›®å‰ç„¡éœ€ç‰¹åˆ¥é—œæ³¨äº‹é …</div>';
        }

        // è¡¨å–®æäº¤
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const dailyLogFile = document.getElementById('daily_log').files[0];
            const carePlanFile = document.getElementById('care_plan').files[0];
            const residentName = document.getElementById('resident_name').value;

            if (!dailyLogFile || !carePlanFile) {
                alert('è«‹é¸æ“‡å…©å€‹æª”æ¡ˆå¾Œå†æäº¤');
                return;
            }

            if (!residentName.trim()) {
                alert('è«‹è¼¸å…¥ä½æˆ¶å§“å');
                return;
            }

            const formData = new FormData(this);
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');

            loading.style.display = 'block';
            results.style.display = 'none';

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    currentData = data;
                    
                    // é¡¯ç¤ºå„å€‹é é¢å…§å®¹
                    document.getElementById('reportContent').innerHTML = data.html;
                    document.getElementById('carePlanContent').innerHTML = data.care_plan.html;
                    
                    // ç”Ÿæˆåœ–è¡¨å’Œçµ±è¨ˆ
                    createCharts(data.structured_data);
                    generateOverview(data.structured_data);
                    displayIncidents(data.structured_data.incidents);
                    
                    results.style.display = 'block';
                } else {
                    alert('åˆ†æå¤±æ•—ï¼š' + data.error);
                }
            } catch (error) {
                alert('ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
            } finally {
                loading.style.display = 'none';
            }
        });

        // è¤‡è£½åŠŸèƒ½
        document.getElementById('copyBtn').addEventListener('click', function() {
            if (currentData) {
                navigator.clipboard.writeText(currentData.markdown)
                    .then(() => alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼'))
                    .catch(err => alert('è¤‡è£½å¤±æ•—ï¼š' + err));
            }
        });

        // ä¸‹è¼‰åˆ†æå ±å‘Š
        document.getElementById('downloadBtn').addEventListener('click', async function() {
            if (currentData) {
                try {
                    const response = await fetch('/download', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            content: currentData.markdown,
                            resident_name: document.getElementById('resident_name').value
                        })
                    });

                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `è­·ç†è¨ˆåŠƒåˆ†æ_${document.getElementById('resident_name').value}_${new Date().toISOString().slice(0,10)}.md`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                } catch (error) {
                    alert('ä¸‹è¼‰å¤±æ•—ï¼š' + error.message);
                }
            }
        });

        // ä¸‹è¼‰è­·ç†è¨ˆåŠƒ
        document.getElementById('downloadCarePlanBtn').addEventListener('click', async function() {
            if (currentData) {
                try {
                    const response = await fetch('/download', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            content: currentData.care_plan.markdown,
                            resident_name: document.getElementById('resident_name').value
                        })
                    });

                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `æ–°è­·ç†è¨ˆåŠƒ_${document.getElementById('resident_name').value}_${new Date().toISOString().slice(0,10)}.md`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                } catch (error) {
                    alert('ä¸‹è¼‰å¤±æ•—ï¼š' + error.message);
                }
            }
        });

        // åˆ—å°åŠŸèƒ½
        document.getElementById('printBtn').addEventListener('click', function() {
            window.print();
        });

        // åŒ¯å‡ºPDFåŠŸèƒ½
        document.getElementById('exportPdfBtn').addEventListener('click', function() {
            if (currentData) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFont("helvetica");
                doc.setFontSize(16);
                doc.text('è­·ç†è¨ˆåŠƒåˆ†æå ±å‘Š', 20, 20);
                
                const content = currentData.markdown.replace(/[^\x00-\x7F]/g, "?");
                const lines = doc.splitTextToSize(content, 170);
                doc.setFontSize(10);
                doc.text(lines, 20, 40);
                
                doc.save(`è­·ç†è¨ˆåŠƒåˆ†æ_${document.getElementById('resident_name').value}.pdf`);
            }
        });

        // æ–°åˆ†æ
        document.getElementById('newAnalysisBtn').addEventListener('click', function() {
            document.getElementById('uploadForm').reset();
            document.querySelectorAll('.file-info').forEach(el => el.textContent = '');
            document.getElementById('results').style.display = 'none';
            currentData = null;
        });

        // æ‹–æ”¾åŠŸèƒ½
        document.querySelectorAll('.upload-box').forEach(box => {
            const input = box.querySelector('input[type="file"]');

            ['dragenter', 'dragover'].forEach(eventName => {
                box.addEventListener(eventName, function(e) {
                    e.preventDefault();
                    box.classList.add('drag-over');
                });
            });

            ['dragleave', 'drop'].forEach(eventName => {
                box.addEventListener(eventName, function(e) {
                    e.preventDefault();
                    box.classList.remove('drag-over');
                });
            });

            box.addEventListener('drop', function(e) {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    input.files = files;
                    const event = new Event('change', { bubbles: true });
                    input.dispatchEvent(event);
                }
            });
        });
    </script>
</body>
</html>
