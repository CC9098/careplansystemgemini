<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè• Care Plan AI Analysis Platform</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üè• Care Plan AI Analysis Platform</h1>
            <p>Upload resident logs and current care plan. AI will analyze and provide optimization suggestions.</p>
        </header>

        <main>
            <!-- Step 1: File Upload -->
            <form id="uploadForm" class="upload-section">
                <div class="form-group">
                    <label for="resident_name">Resident Name:</label>
                    <input type="text" id="resident_name" name="resident_name" placeholder="Enter resident name" required>
                </div>

                <div class="upload-grid">
                    <div class="upload-box">
                        <h3>üìã Monthly Care Log</h3>
                        <input type="file" id="daily_log" name="daily_log" accept=".csv,.txt" required>
                        <label for="daily_log" class="file-label">
                            <span>Click to select log file</span>
                        </label>
                        <p class="file-info">Supports CSV and TXT files</p>
                    </div>

                    <div class="upload-box">
                        <h3>üìÑ Current Care Plan</h3>
                        <input type="file" id="care_plan" name="care_plan" accept=".csv,.txt" required>
                        <label for="care_plan" class="file-label">
                            <span>Click to select care plan</span>
                        </label>
                        <p class="file-info">Supports CSV and TXT files</p>
                    </div>
                </div>

                <button type="submit" class="analyze-btn">üìä Analyze & Get Suggestions</button>
            </form>

            <!-- Loading -->
            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>AI is analyzing files, please wait...</p>
            </div>

            <!-- Step 2: Suggestion Selection -->
            <div id="suggestions" class="results-section" style="display: none;">
                <h2>üìã Care Plan Update Suggestions</h2>

                <div id="analysisSummary" class="analysis-summary"></div>

                <div class="suggestions-container">
                    <h3>Select suggestions to implement:</h3>
                    <div id="suggestionsList"></div>

                    <div class="manager-comments">
                        <h4>Additional Comments/Suggestions:</h4>
                        <textarea id="managerComments" placeholder="Add your own observations or modifications..."></textarea>
                    </div>

                    <button id="generatePlanBtn" class="analyze-btn">‚úÖ Generate Updated Care Plan</button>
                </div>
            </div>

            <!-- Step 3: Final Care Plan -->
            <div id="finalPlan" class="results-section" style="display: none;">
                <div class="results-header">
                    <h2>üìÑ Updated Care Plan</h2>
                    <div class="action-buttons">
                        <button id="copyBtn" class="action-btn">üìã Copy</button>
                        <button id="downloadBtn" class="action-btn">üì• Download</button>
                        <button id="startOverBtn" class="action-btn">üîÑ Start Over</button>
                    </div>
                </div>
                <div id="carePlanContent" class="content"></div>
            </div>

            <!-- Data Visualization -->
            <div id="charts" class="charts-section" style="display: none;">
                <h2>üìä Care Data Analysis</h2>
                <div class="charts-grid">
                    <canvas id="waterChart"></canvas>
                    <canvas id="bowelChart"></canvas>
                    <canvas id="foodChart"></canvas>
                </div>
                <div id="statsDisplay" class="stats-display"></div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let currentData = {};
        let charts = {};

        // File upload handlers
        document.getElementById('daily_log').addEventListener('change', function(e) {
            updateFileLabel(this, 'Click to select log file');
        });

        document.getElementById('care_plan').addEventListener('change', function(e) {
            updateFileLabel(this, 'Click to select care plan');
        });

        function updateFileLabel(input, defaultText) {
            const label = input.nextElementSibling.querySelector('span');
            label.textContent = input.files.length > 0 ? input.files[0].name : defaultText;
        }

        // Step 1: Upload and analyze
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const loading = document.getElementById('loading');
            const suggestions = document.getElementById('suggestions');
            const finalPlan = document.getElementById('finalPlan');
            const charts = document.getElementById('charts');

            // Hide all sections
            suggestions.style.display = 'none';
            finalPlan.style.display = 'none';
            charts.style.display = 'none';
            loading.style.display = 'block';

            try {
                const formData = new FormData(this);
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success && data.step === 'suggestions') {
                    currentData = data;
                    displaySuggestions(data);
                    suggestions.style.display = 'block';

                    // Show charts if data available
                    if (data.structured_data) {
                        displayCharts(data.structured_data);
                        charts.style.display = 'block';
                    }
                } else {
                    alert('Analysis failed: ' + data.error);
                }
            } catch (error) {
                alert('Error occurred: ' + error.message);
            } finally {
                loading.style.display = 'none';
            }
        });

        function displaySuggestions(data) {
            // Display analysis summary
            document.getElementById('analysisSummary').innerHTML = `
                <h4>Analysis Summary:</h4>
                <p>${data.analysis_summary}</p>
            `;

            // Display suggestions as checkboxes
            const suggestionsList = document.getElementById('suggestionsList');
            suggestionsList.innerHTML = '';

            data.suggestions.forEach((suggestion, index) => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.innerHTML = `
                    <label class="suggestion-label">
                        <input type="checkbox" name="suggestion" value="${index}" checked>
                        <span class="priority priority-${suggestion.priority.toLowerCase()}">${suggestion.priority}</span>
                        <strong>${suggestion.category}:</strong> ${suggestion.suggestion}
                        <small class="reason">Reason: ${suggestion.reason}</small>
                    </label>
                `;
                suggestionsList.appendChild(div);
            });
        }

        // Step 3: Generate final care plan
        document.getElementById('generatePlanBtn').addEventListener('click', async function() {
            const loading = document.getElementById('loading');
            const finalPlan = document.getElementById('finalPlan');

            loading.style.display = 'block';

            try {
                // Get selected suggestions
                const selectedCheckboxes = document.querySelectorAll('input[name="suggestion"]:checked');
                const selectedSuggestions = Array.from(selectedCheckboxes).map(cb => 
                    currentData.suggestions[parseInt(cb.value)]
                );

                const managerComments = document.getElementById('managerComments').value;

                const response = await fetch('/generate_care_plan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        original_care_plan: currentData.original_care_plan,
                        selected_suggestions: selectedSuggestions,
                        manager_comments: managerComments,
                        resident_name: currentData.resident_name
                    })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('carePlanContent').innerHTML = data.care_plan.html;
                    finalPlan.style.display = 'block';

                    // Store for download
                    window.currentReport = {
                        content: data.care_plan.markdown,
                        resident_name: currentData.resident_name
                    };

                    // Scroll to results
                    finalPlan.scrollIntoView({ behavior: 'smooth' });
                } else {
                    alert('Care plan generation failed: ' + data.error);
                }
            } catch (error) {
                alert('Error occurred: ' + error.message);
            } finally {
                loading.style.display = 'none';
            }
        });

        // Copy functionality
        document.getElementById('copyBtn').addEventListener('click', function() {
            if (window.currentReport) {
                navigator.clipboard.writeText(window.currentReport.content)
                    .then(() => alert('Copied to clipboard!'))
                    .catch(err => alert('Copy failed: ' + err));
            }
        });

        // Download functionality
        document.getElementById('downloadBtn').addEventListener('click', async function() {
            if (window.currentReport) {
                try {
                    const response = await fetch('/download', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(window.currentReport)
                    });

                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `Care_Plan_${window.currentReport.resident_name}_${new Date().getTime()}.md`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                } catch (error) {
                    alert('Download failed: ' + error.message);
                }
            }
        });

        // Start over functionality
        document.getElementById('startOverBtn').addEventListener('click', function() {
            document.getElementById('suggestions').style.display = 'none';
            document.getElementById('finalPlan').style.display = 'none';
            document.getElementById('charts').style.display = 'none';
            document.getElementById('uploadForm').reset();
            updateFileLabel(document.getElementById('daily_log'), 'Click to select log file');
            updateFileLabel(document.getElementById('care_plan'), 'Click to select care plan');
            window.currentReport = null;
            currentData = {};
        });

        // Chart display functions
        function displayCharts(data) {
            displayStats(data);
            createWaterChart(data.water_intake);
            createBowelChart(data.bowel_movements);
            createFoodChart(data.food_intake);
        }

        function displayStats(data) {
            const avgWater = data.water_intake.length > 0 
                ? Math.round(data.water_intake.reduce((sum, item) => sum + item.amount, 0) / data.water_intake.length)
                : 0;

            const avgBowel = data.bowel_movements.length > 0 
                ? (data.bowel_movements.reduce((sum, item) => sum + item.count, 0) / data.bowel_movements.length).toFixed(1)
                : 0;

            const avgFood = data.food_intake.length > 0 
                ? Math.round(data.food_intake.reduce((sum, item) => sum + item.percentage, 0) / data.food_intake.length)
                : 0;

            document.getElementById('statsDisplay').innerHTML = `
                <div class="stats-grid">
                    <div class="stat-item">
                        <h4>Average Water Intake:</h4>
                        <p>${avgWater} ml</p>
                    </div>
                    <div class="stat-item">
                        <h4>Average Bowel Movements:</h4>
                        <p>${avgBowel} times/day</p>
                    </div>
                    <div class="stat-item">
                        <h4>Average Food Intake:</h4>
                        <p>${avgFood}%</p>
                    </div>
                    <div class="stat-item">
                        <h4>Incident Events:</h4>
                        <p>${data.incidents.length} events</p>
                    </div>
                </div>
            `;
        }

        function createWaterChart(waterData) {
            const ctx = document.getElementById('waterChart').getContext('2d');
            if (charts.waterChart) charts.waterChart.destroy();

            const labels = waterData.map(item => item.date);
            const amounts = waterData.map(item => item.amount);

            charts.waterChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Water Intake (ml)',
                        data: amounts,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Daily Water Intake'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 4000
                        }
                    }
                }
            });
        }

        function createBowelChart(bowelData) {
            const ctx = document.getElementById('bowelChart').getContext('2d');
            if (charts.bowelChart) charts.bowelChart.destroy();

            const labels = bowelData.map(item => item.date);
            const counts = bowelData.map(item => item.count);

            charts.bowelChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Bowel Movements',
                        data: counts,
                        backgroundColor: 'rgba(230, 126, 34, 0.8)',
                        borderColor: '#e67e22',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Daily Bowel Movements'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10
                        }
                    }
                }
            });
        }

        function createFoodChart(foodData) {
            const ctx = document.getElementById('foodChart').getContext('2d');
            if (charts.foodChart) charts.foodChart.destroy();

            const labels = foodData.map(item => item.date);
            const percentages = foodData.map(item => item.percentage);

            charts.foodChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Food Intake (%)',
                        data: percentages,
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Daily Food Intake Percentage'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>